'use client'

import { useState } from 'react'
import { addDoc, collection, serverTimestamp } from 'firebase/firestore'
import { db, storage } from '@/lib/firebase'
import { useAuthStore } from '@/stores/authStore'
import { useRouter } from 'next/navigation'
import { v4 as uuidv4 } from 'uuid'
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage'

const categories = [
  'íŒ¬ë¤', 'ì—°ì˜ˆÂ·ì‚¬ë‘', 'ë°©ì†¡Â·ì±„ë„', 'íŒ¨ì…˜Â·ë·°í‹°', 'ìŒì‹Â·ìš”ë¦¬',
  'ì·¨ë¯¸Â·ì—¬í–‰', 'ì¼ìƒ', 'ì‚¬íšŒÂ·ë¬¸í™”', 'ê¸°ìˆ ', 'ì •ì¹˜', 'ê²½ì œ', 'êµìœ¡', 'ììœ ì£¼ì œ'
]

interface Option {
  text: string
  imageFile?: File | null
  imagePreview?: string | null
  imageUrl?: string | null
}

const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

const isValidImageType = (file: File): boolean => {
  const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  return validTypes.includes(file.type);
};

export default function CreatePollPage() {
  const router = useRouter()
  const { user } = useAuthStore()

  const [title, setTitle] = useState('')
  const [category, setCategory] = useState('')
  const [options, setOptions] = useState<Option[]>([{ text: '' }, { text: '' }])
  const [mainImage, setMainImage] = useState<File | null>(null)
  const [mainImagePreview, setMainImagePreview] = useState<string | null>(null)
  const [isPublic, setIsPublic] = useState(true)
  const [password, setPassword] = useState('')
  const [passwordConfirm, setPasswordConfirm] = useState('')
  const [deadline, setDeadline] = useState('')
  const [maxParticipants, setMaxParticipants] = useState<number | null>(null)

  const today = new Date().toISOString().split('T')[0]
  const maxDate = new Date()
  maxDate.setDate(maxDate.getDate() + 30)
  const maxDateStr = maxDate.toISOString().split('T')[0]

  const handleOptionChange = (index: number, value: string) => {
    const updated = [...options]
    updated[index].text = value
    setOptions(updated)
  }

  const handleOptionImageChange = (index: number, file: File | null) => {
    if (!file) return;
    
    console.log('ğŸ“ ì´ë¯¸ì§€ íŒŒì¼ ì •ë³´:', {
      name: file.name,
      type: file.type,
      size: file.size,
    });
    
    if (!isValidImageType(file)) {
      alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹ì…ë‹ˆë‹¤. (JPEG, PNG, GIF, WEBPë§Œ ê°€ëŠ¥)');
      return;
    }
    
    if (file.size > MAX_FILE_SIZE) {
      alert('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
      return;
    }
    
    const updated = [...options];
    updated[index].imageFile = file;
    updated[index].imagePreview = URL.createObjectURL(file);
    setOptions(updated);
  }

  const handleDeleteOptionImage = (index: number) => {
    const updated = [...options]
    updated[index].imageFile = null
    updated[index].imagePreview = null
    updated[index].imageUrl = null
    setOptions(updated)
  }

  const handleAddOption = () => {
    if (options.length < 10) setOptions([...options, { text: '' }])
  }

  const handleRemoveOption = (index: number) => {
    if (options.length <= 2) return
    setOptions(options.filter((_, i) => i !== index))
  }

  const handleMainImageChange = (file: File | null) => {
    if (!file) return;
    
    console.log('ğŸ–¼ ëŒ€í‘œ ì´ë¯¸ì§€ íŒŒì¼ ì •ë³´:', {
      name: file.name,
      type: file.type,
      size: file.size,
    });
    
    if (!isValidImageType(file)) {
      alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹ì…ë‹ˆë‹¤. (JPEG, PNG, GIF, WEBPë§Œ ê°€ëŠ¥)');
      return;
    }
    
    if (file.size > MAX_FILE_SIZE) {
      alert('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
      return;
    }
    
    setMainImage(file);
    setMainImagePreview(URL.createObjectURL(file));
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    try {
      console.log('ğŸŸ¡ [ì‹œì‘] íˆ¬í‘œ ë“±ë¡ í”„ë¡œì„¸ìŠ¤ ì‹œì‘')

      if (!user) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.')
        return
      }
      if (!title.trim()) {
        alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.')
        return
      }
      if (!category) {
        alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.')
        return
      }
      if (options.some((opt) => !opt.text.trim())) {
        alert('ë¹ˆ ì˜µì…˜ì´ ìˆìŠµë‹ˆë‹¤.')
        return
      }
      if (options.filter((opt) => opt.text.trim()).length < 2) {
        alert('ì˜µì…˜ì€ ìµœì†Œ 2ê°œ ì´ìƒ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.')
        return
      }
      if (!isPublic) {
        if (password.length < 6 || password.length > 12) {
          alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒ 12ì ì´í•˜ë¡œ ì…ë ¥í•˜ì„¸ìš”.')
          return
        }
        if (password !== passwordConfirm) {
          alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')
          return
        }
      }

      console.log('ğŸ“¤ ì˜µì…˜ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘...')
      const uploadedOptions = await Promise.all(
        options.map(async (opt) => {
          try {
            let imageUrl = null;
            if (opt.imageFile) {
              try {
                console.log(`ğŸ–¼ ì˜µì…˜ ì´ë¯¸ì§€ íŒŒì¼:`, opt.imageFile);
                const imageRef = ref(storage, `polls/options/${uuidv4()}`);
                console.log('ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘...');
                await uploadBytes(imageRef, opt.imageFile);
                console.log('âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ');
                imageUrl = await getDownloadURL(imageRef);
                console.log(`ğŸ”— ì´ë¯¸ì§€ URL: ${imageUrl}`);
              } catch (err) {
                console.error(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨ (ì˜µì…˜: ${opt.text}):`, err);
                // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
              }
            }
            return {
              id: uuidv4(),
              text: opt.text.trim(),
              imageUrl,
              votes: [],
            };
          } catch (err) {
            console.error(`ì˜µì…˜ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, err);
            throw err;
          }
        })
      );

      // ê¸°ë³¸ ì´ë¯¸ì§€ URL ì„¤ì •
      const DEFAULT_MAIN_IMAGE = 'https://firebasestorage.googleapis.com/v0/b/myvote-8f5c7.appspot.com/o/default%2Fdefault_main.jpg?alt=media';
      
      let mainImageUrl = DEFAULT_MAIN_IMAGE;
      if (mainImage) {
        try {
          console.log('ğŸ–¼ ëŒ€í‘œ ì´ë¯¸ì§€ íŒŒì¼:', mainImage);
          const mainRef = ref(storage, `polls/main/${uuidv4()}`);
          console.log('ğŸ“¤ ëŒ€í‘œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘...');
          
          // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì „ íŒŒì¼ ê²€ì¦
          if (!isValidImageType(mainImage)) {
            throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹ì…ë‹ˆë‹¤.');
          }
          if (mainImage.size > MAX_FILE_SIZE) {
            throw new Error('ì´ë¯¸ì§€ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤.');
          }
          
          // ì´ë¯¸ì§€ ì—…ë¡œë“œ íƒ€ì„ì•„ì›ƒ ì„¤ì •
          const uploadPromise = uploadBytes(mainRef, mainImage);
          const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œê°„ ì´ˆê³¼')), 10000)
          );
          
          await Promise.race([uploadPromise, timeoutPromise]);
          console.log('âœ… ëŒ€í‘œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ');
          mainImageUrl = await getDownloadURL(mainRef);
          console.log(`ğŸ”— ëŒ€í‘œ ì´ë¯¸ì§€ URL: ${mainImageUrl}`);
        } catch (err) {
          console.error('ëŒ€í‘œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', err);
          alert('ëŒ€í‘œ ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤.');
          // ê¸°ë³¸ ì´ë¯¸ì§€ URL ì‚¬ìš©
          mainImageUrl = DEFAULT_MAIN_IMAGE;
        }
      }

      console.log('ğŸ“ íˆ¬í‘œ ë°ì´í„° ì €ì¥ ì‹œì‘...');
      const pollData = {
        title,
        category,
        options: uploadedOptions,
        isPublic,
        password: isPublic ? null : password,
        deadline: new Date(deadline),
        maxParticipants: maxParticipants || null,
        createdAt: serverTimestamp(),
        createdBy: user.uid,
        mainImageUrl,
      };
      
      console.log('ğŸ“¤ íˆ¬í‘œ ë°ì´í„°:', pollData);
      await addDoc(collection(db, 'polls'), pollData);

      console.log('âœ… [ì™„ë£Œ] íˆ¬í‘œ ë“±ë¡ ì„±ê³µ');
      alert('íˆ¬í‘œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      router.push('/mypage');
    } catch (error) {
      console.error('âŒ ì „ì²´ ë“±ë¡ ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
      alert('íˆ¬í‘œ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    }
  }

  return (
    <div className="max-w-2xl mx-auto py-12 px-8 bg-white shadow-md rounded-xl">
      <h1 className="text-2xl font-bold text-center mb-8">ğŸ“ íˆ¬í‘œ ë§Œë“¤ê¸°</h1>
      <form onSubmit={handleSubmit} className="space-y-6">
        {/* === ê³µê°œ ì—¬ë¶€ === */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">ê³µê°œ ì—¬ë¶€</label>
          <select
            value={isPublic ? 'public' : 'private'}
            onChange={(e) => setIsPublic(e.target.value === 'public')}
            className="w-full px-4 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
          >
            <option value="public">ê³µê°œ íˆ¬í‘œ</option>
            <option value="private">ë¹„ê³µê°œ íˆ¬í‘œ</option>
          </select>
        </div>

        {!isPublic && (
          <div className="space-y-3">
            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-2 border rounded-md text-sm" placeholder="ë¹„ë°€ë²ˆí˜¸ (6~12ì)" />
            <input type="password" value={passwordConfirm} onChange={(e) => setPasswordConfirm(e.target.value)} className="w-full px-4 py-2 border rounded-md text-sm" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥" />
          </div>
        )}

        {/* === ì œëª© === */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">ì œëª©</label>
          <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full px-4 py-2 border rounded-md text-sm" required />
        </div>

        {/* === ëŒ€í‘œ ì´ë¯¸ì§€ === */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">ëŒ€í‘œ ì´ë¯¸ì§€ (ì„ íƒ)</label>
          <input type="file" accept="image/*" onChange={(e) => handleMainImageChange(e.target.files?.[0] ?? null)} className="block w-full text-sm" />
          {mainImagePreview && <img src={mainImagePreview} alt="ë¯¸ë¦¬ë³´ê¸°" className="mt-2 w-full rounded-lg border" />}
        </div>

        {/* === ì¹´í…Œê³ ë¦¬ === */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">ì¹´í…Œê³ ë¦¬</label>
          <select value={category} onChange={(e) => setCategory(e.target.value)} className="w-full px-4 py-2 border rounded-md text-sm" required>
            <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
            {categories.map((cat) => (
              <option key={cat} value={cat}>{cat}</option>
            ))}
          </select>
        </div>

        {/* === ì˜µì…˜ === */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">íˆ¬í‘œ ì˜µì…˜</label>
          <div className="space-y-4">
            {options.map((opt, idx) => (
              <div key={idx} className="space-y-1">
                <div className="flex items-center gap-2">
                  <input type="text" value={opt.text} onChange={(e) => handleOptionChange(idx, e.target.value)} className="flex-1 px-4 py-2 border rounded-md text-sm" placeholder={`ì˜µì…˜ ${idx + 1}`} required />
                  {options.length > 2 && (
                    <button type="button" onClick={() => handleRemoveOption(idx)} className="text-red-600 text-sm">ğŸ—‘ ì‚­ì œ</button>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  <input type="file" accept="image/*" onChange={(e) => handleOptionImageChange(idx, e.target.files?.[0] ?? null)} className="text-sm" />
                  {opt.imagePreview && (
                    <div className="relative w-32">
                      <img src={opt.imagePreview} className="w-full rounded border" />
                      <button type="button" onClick={() => handleDeleteOptionImage(idx)} className="absolute top-1 right-1 text-xs bg-red-500 text-white px-2 py-1 rounded">ì‚­ì œ</button>
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
          {options.length < 10 && (
            <button type="button" onClick={handleAddOption} className="text-sm text-purple-600 mt-2 hover:underline">+ ì˜µì…˜ ì¶”ê°€</button>
          )}
        </div>

        {/* === ë§ˆê°ì¼ === */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">ë§ˆê°ì¼</label>
          <input type="date" value={deadline} onChange={(e) => setDeadline(e.target.value)} min={today} max={maxDateStr} className="w-full px-4 py-2 border rounded-md text-sm" required />
          <p className="text-xs text-gray-500 mt-1">ì˜¤ëŠ˜ë¶€í„° 30ì¼ ì´ë‚´ë§Œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        {/* === ì°¸ì—¬ì ìˆ˜ === */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">ì°¸ì—¬ì ìˆ˜ (ì„ íƒ)</label>
          <input type="number" min={1} value={maxParticipants ?? ''} onChange={(e) => setMaxParticipants(Number(e.target.value))} className="w-full px-4 py-2 border rounded-md text-sm" placeholder="ì˜ˆ: 100" />
        </div>

        <div className="text-right">
          <button type="submit" className="bg-purple-600 text-white px-6 py-2 rounded-full hover:bg-purple-700 transition">ë“±ë¡í•˜ê¸°</button>
        </div>
      </form>
    </div>
  )
}
